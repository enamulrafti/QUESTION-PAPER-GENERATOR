<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Question Paper Generator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 1cm auto;
            border: 1px #D3D3D3 solid;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        @media print {
            body, .a4-page { margin: 0; box-shadow: none; border: none; }
            .no-print { display: none; }
        }
        .table-cell-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            padding: 4px;
            border-radius: 4px;
        }
        .step { transition: all 0.3s ease; }
        /* Loading Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">AI-Powered Question Paper Generator</h1>
            <p class="text-lg text-gray-600 mt-2">Create, preview, and download professional question papers with ease.</p>
        </header>

        <!-- Stepper Navigation -->
        <div class="w-full max-w-4xl mx-auto mb-8 p-4 bg-white rounded-lg shadow-md no-print">
            <div class="flex items-center justify-center">
                <div id="step-indicator-1" class="step flex items-center text-blue-600 border-b-4 border-blue-600 py-2 px-4">
                    <div class="rounded-full h-8 w-8 flex items-center justify-center bg-blue-600 text-white font-bold">1</div>
                    <span class="ml-3 font-semibold">Header Info</span>
                </div>
                <div class="flex-auto border-t-2 transition duration-500 ease-in-out border-gray-300"></div>
                <div id="step-indicator-2" class="step flex items-center text-gray-500 py-2 px-4">
                    <div class="rounded-full h-8 w-8 flex items-center justify-center bg-gray-300 text-gray-700 font-bold">2</div>
                    <span class="ml-3 font-semibold">Questions</span>
                </div>
                <div class="flex-auto border-t-2 transition duration-500 ease-in-out border-gray-300"></div>
                <div id="step-indicator-3" class="step flex items-center text-gray-500 py-2 px-4">
                    <div class="rounded-full h-8 w-8 flex items-center justify-center bg-gray-300 text-gray-700 font-bold">3</div>
                    <span class="ml-3 font-semibold">Preview & Download</span>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="app" class="w-full max-w-4xl mx-auto">

            <!-- Step 1: Header Information -->
            <section id="step-1" class="bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-4">Header Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- All header inputs remain the same -->
                    <div><label for="universityName" class="block text-sm font-medium text-gray-700">University Name</label><input type="text" id="universityName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., International University"></div>
                    <div><label for="universityLogo" class="block text-sm font-medium text-gray-700">University Logo</label><input type="file" id="universityLogo" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img id="logoPreview" src="" alt="Logo Preview" class="mt-2 h-16 hidden rounded-md"/></div>
                    <div><label for="departmentName" class="block text-sm font-medium text-gray-700">Department Name</label><input type="text" id="departmentName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Dept. of Computer Science & Engineering"></div>
                    <div><label for="courseName" class="block text-sm font-medium text-gray-700">Course Name</label><input type="text" id="courseName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Data Structures"></div>
                    <div><label for="courseCode" class="block text-sm font-medium text-gray-700">Course Code</label><input type="text" id="courseCode" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., CSE 2216"></div>
                    <div><label for="examType" class="block text-sm font-medium text-gray-700">Exam Type</label><input type="text" id="examType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Midterm Examination"></div>
                    <div><label for="totalMarks" class="block text-sm font-medium text-gray-700">Total Marks</label><input type="number" id="totalMarks" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 50"></div>
                    <div><label for="totalTime" class="block text-sm font-medium text-gray-700">Total Time</label><input type="text" id="totalTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 90 minutes"></div>
                    <div class="md:col-span-2"><label for="setNumber" class="block text-sm font-medium text-gray-700">Set Number (optional)</label><input type="text" id="setNumber" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., A"></div>
                </div>
                <div class="mt-8 text-right"><button onclick="goToStep(2)" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Next: Add Questions &rarr;</button></div>
            </section>

            <!-- Step 2: Questions -->
            <section id="step-2" class="bg-white p-8 rounded-lg shadow-lg hidden">
                <div class="flex justify-between items-center border-b pb-4 mb-6">
                    <h2 class="text-2xl font-bold">Questions</h2>
                    <button onclick="openGenerateQuestionsModal()" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Generate Questions with AI âœ¨
                    </button>
                </div>
                <div id="questions-container"></div>
                <div class="mt-6 flex justify-between items-center">
                    <button onclick="addQuestion()" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">+ Add Another Question</button>
                    <div>
                        <button onclick="goToStep(1)" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">&larr; Back</button>
                        <button onclick="goToStep(3)" class="ml-4 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Next: Preview &rarr;</button>
                    </div>
                </div>
            </section>

            <!-- Step 3: Preview and Download -->
            <section id="step-3" class="hidden">
                 <div class="bg-white p-8 rounded-lg shadow-lg mb-8 no-print">
                    <h2 class="text-2xl font-bold mb-4">Preview & Download</h2>
                    <p class="text-gray-600 mb-6">Choose a template below. The selected template will be used for the PDF download.</p>
                    <div class="flex justify-between items-center">
                        <button onclick="goToStep(2)" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">&larr; Back to Questions</button>
                        <button id="downloadPdfBtn" class="inline-flex items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>Download as PDF</button>
                    </div>
                </div>
                <div id="preview-container" class="space-y-8">
                    <div id="template1" class="a4-page template-content cursor-pointer border-4 border-blue-500" onclick="selectTemplate('template1')"></div>
                    <div id="template2" class="a4-page template-content cursor-pointer" onclick="selectTemplate('template2')"></div>
                    <div id="template3" class="a4-page template-content cursor-pointer" onclick="selectTemplate('template3')"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="table-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50"><div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><h3 class="text-lg leading-6 font-medium text-gray-900">Create Table</h3><div class="mt-2 px-7 py-3"><input type="number" id="table-rows" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Number of Rows"><input type="number" id="table-cols" class="mt-4 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Number of Columns"></div><div class="items-center px-4 py-3"><button id="create-table-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700">Create Table</button><button onclick="closeModal('table-modal')" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">Cancel</button></div></div></div></div>
    <div id="ai-questions-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50"><div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white"><div class="mt-3"><h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Generate Questions with AI âœ¨</h3><div class="mt-4 space-y-4"><input type="text" id="ai-topic" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="Enter topic (e.g., Photosynthesis)"><input type="number" id="ai-num-questions" class="block w-full rounded-md border-gray-300 shadow-sm" placeholder="Number of questions"><select id="ai-question-type" class="block w-full rounded-md border-gray-300 shadow-sm"><option>Multiple Choice</option><option>Short Answer</option><option>True/False</option><option>Essay</option></select></div><div class="items-center px-4 py-3 mt-4 flex gap-2"><button onclick="handleGenerateQuestions()" class="w-full px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-purple-700">Generate</button><button onclick="closeModal('ai-questions-modal')" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button></div></div></div></div>
    <div id="ai-distractors-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50"><div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white"><div class="mt-3"><h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Generate Distractors âœ¨</h3><div class="mt-2 py-3"><p class="text-sm text-gray-600 mb-2">For question:</p><p id="distractor-q-text" class="text-sm text-gray-800 font-semibold bg-gray-100 p-2 rounded-md"></p><input type="text" id="ai-correct-answer" class="mt-4 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Enter the CORRECT answer here"></div><div class="items-center px-4 py-3 mt-2 flex gap-2"><button onclick="handleGenerateDistractors()" class="w-full px-4 py-2 bg-teal-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-teal-700">Generate</button><button onclick="closeModal('ai-distractors-modal')" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button></div></div></div></div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden"><div class="loader"></div><p class="text-white text-lg mt-4">AI is thinking...</p></div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            header: { universityName: '', universityLogo: '', departmentName: '', courseName: '', courseCode: '', examType: '', totalMarks: '', totalTime: '', setNumber: '' },
            questions: [],
            currentStep: 1,
            selectedTemplate: 'template1'
        };
        let currentQuestionIdForTable = null;
        let currentQuestionIdForAI = null;

        // --- DOM ELEMENTS ---
        const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
        const stepIndicators = [document.getElementById('step-indicator-1'), document.getElementById('step-indicator-2'), document.getElementById('step-indicator-3')];
        const questionsContainer = document.getElementById('questions-container');
        const logoPreview = document.getElementById('logoPreview');
        const universityLogoInput = document.getElementById('universityLogo');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            addQuestion();
            bindHeaderInputs();
            universityLogoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.header.universityLogo = e.target.result;
                        logoPreview.src = e.target.result;
                        logoPreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);
            document.getElementById('create-table-btn').addEventListener('click', createTable);
        });

        // --- NAVIGATION ---
        function goToStep(stepNumber) {
            state.currentStep = stepNumber;
            steps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== stepNumber));
            updateStepIndicator();
            if (stepNumber === 3) updateAllPreviews();
            window.scrollTo(0, 0);
        }
        
        function updateStepIndicator() {
            stepIndicators.forEach((indicator, index) => {
                const circle = indicator.querySelector('.rounded-full');
                const isActive = index === state.currentStep - 1;
                indicator.classList.toggle('text-blue-600', isActive);
                indicator.classList.toggle('border-blue-600', isActive);
                indicator.classList.toggle('text-gray-500', !isActive);
                circle.classList.toggle('bg-blue-600', isActive);
                circle.classList.toggle('text-white', isActive);
                circle.classList.toggle('bg-gray-300', !isActive);
            });
        }

        // --- HEADER DATA BINDING ---
        function bindHeaderInputs() {
            Object.keys(state.header).forEach(key => {
                const input = document.getElementById(key);
                if (input && key !== 'universityLogo') {
                    input.addEventListener('input', (e) => state.header[key] = e.target.value);
                }
            });
        }

        // --- QUESTION MANAGEMENT ---
        function addQuestion(qData = null) {
            const questionId = `q-${Date.now()}`;
            const newQuestion = qData ? { ...qData, id: questionId } : { id: questionId, number: '', details: '', image: '', table: { rows: 0, cols: 0, data: [] }, marks: '' };
            state.questions.push(newQuestion);
            renderQuestions();
        }

        function removeQuestion(id) {
            state.questions = state.questions.filter(q => q.id !== id);
            renderQuestions();
        }

        function updateQuestionField(id, field, value) {
            const question = state.questions.find(q => q.id === id);
            if (question) question[field] = value;
        }

        function handleQuestionImage(event, id) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    updateQuestionField(id, 'image', e.target.result);
                    const imgPreview = document.querySelector(`#${id} .question-image-preview`);
                    imgPreview.src = e.target.result;
                    imgPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function renderQuestions() {
            questionsContainer.innerHTML = '';
            state.questions.forEach((q, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.id = q.id;
                questionBlock.className = 'p-6 bg-gray-50 border border-gray-200 rounded-lg mb-4';
                questionBlock.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Question ${index + 1}</h3>
                        <button onclick="removeQuestion('${q.id}')" class="text-red-500 hover:text-red-700 font-semibold">&times; Remove</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700">Q. Number</label><input type="text" value="${q.number}" oninput="updateQuestionField('${q.id}', 'number', this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., 1(a)"></div>
                        <div class="md:col-span-3"><label class="block text-sm font-medium text-gray-700">Marks</label><input type="number" value="${q.marks}" oninput="updateQuestionField('${q.id}', 'marks', this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="e.g., 10"></div>
                        <div class="md:col-span-4">
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Question Details</label>
                                <button onclick="openDistractorsModal('${q.id}')" class="text-xs font-semibold text-teal-600 hover:text-teal-800">Generate Distractors âœ¨</button>
                            </div>
                            <textarea id="details-${q.id}" oninput="updateQuestionField('${q.id}', 'details', this.value)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" rows="4" placeholder="Type the question here...">${q.details}</textarea>
                        </div>
                        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700">Attach Image</label><input type="file" accept="image/*" onchange="handleQuestionImage(event, '${q.id}')" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><img src="${q.image || ''}" class="question-image-preview mt-2 h-20 ${q.image ? '' : 'hidden'} rounded-md"/></div>
                        <div class="md:col-span-2 flex items-end"><button onclick="openTableModal('${q.id}')" class="w-full py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add/Edit Table</button></div>
                        <div class="md:col-span-4 table-container"></div>
                    </div>`;
                questionsContainer.appendChild(questionBlock);
                if (q.table.rows > 0) renderTableInForm(q.id);
            });
        }

        // --- MODAL CONTROLS ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
        
        function openTableModal(questionId) {
            currentQuestionIdForTable = questionId;
            openModal('table-modal');
        }

        function createTable() {
            const rows = parseInt(document.getElementById('table-rows').value) || 0;
            const cols = parseInt(document.getElementById('table-cols').value) || 0;
            const question = state.questions.find(q => q.id === currentQuestionIdForTable);
            if (question) {
                question.table = { rows, cols, data: Array(rows).fill().map(() => Array(cols).fill('')) };
                renderTableInForm(question.id);
            }
            closeModal('table-modal');
        }

        function renderTableInForm(qId) {
            // This function remains largely the same as before
            const question = state.questions.find(q => q.id === qId);
            const container = document.querySelector(`#${qId} .table-container`);
            if (!question || !container || question.table.rows === 0) {
                if(container) container.innerHTML = '';
                return;
            }
            const table = document.createElement('table');
            table.className = 'w-full mt-4 border-collapse border border-gray-400';
            for (let i = 0; i < question.table.rows; i++) {
                const tr = table.insertRow();
                for (let j = 0; j < question.table.cols; j++) {
                    const td = tr.insertCell();
                    td.className = 'border border-gray-300 p-1';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'table-cell-input';
                    input.value = question.table.data[i][j] || '';
                    input.oninput = (e) => {
                        const q = state.questions.find(q => q.id === qId);
                        if (q && q.table.data[i]) q.table.data[i][j] = e.target.value;
                    };
                    td.appendChild(input);
                }
            }
            container.innerHTML = '';
            container.appendChild(table);
        }

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, isJson = false) {
            loadingOverlay.classList.remove('hidden');
            const apiKey = ""; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                alert("An error occurred while contacting the AI. Please check the console for details."); // Using alert as a fallback
                return null;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function openGenerateQuestionsModal() { openModal('ai-questions-modal'); }

        async function handleGenerateQuestions() {
            const topic = document.getElementById('ai-topic').value;
            const numQuestions = document.getElementById('ai-num-questions').value;
            const questionType = document.getElementById('ai-question-type').value;

            if (!topic || !numQuestions) {
                alert("Please provide a topic and the number of questions.");
                return;
            }
            
            const prompt = `Generate ${numQuestions} ${questionType} questions for an exam on the topic of "${topic}".
            Each question should be suitable for a university-level exam.
            Assign a unique question number (e.g., 1, 2, 3...) for each.
            Assign marks for each question, totaling up to ${state.header.totalMarks || 20}. Distribute the marks appropriately.
            For multiple choice questions, provide the question text only, without the options.
            
            Return the response as a JSON array of objects. Each object must have three keys: "number" (string), "details" (string), and "marks" (string).
            Example format: [{"number": "1", "details": "What is...", "marks": "5"}]`;

            const resultText = await callGemini(prompt, true);
            if (resultText) {
                try {
                    const generatedQuestions = JSON.parse(resultText);
                    generatedQuestions.forEach(q => addQuestion(q));
                    closeModal('ai-questions-modal');
                } catch (e) {
                    console.error("Failed to parse AI response:", e);
                    alert("The AI returned an invalid format. Please try again.");
                }
            }
        }

        function openDistractorsModal(questionId) {
            currentQuestionIdForAI = questionId;
            const question = state.questions.find(q => q.id === questionId);
            if (question) {
                document.getElementById('distractor-q-text').innerText = question.details;
                openModal('ai-distractors-modal');
            }
        }

        async function handleGenerateDistractors() {
            const correctAnswer = document.getElementById('ai-correct-answer').value;
            const question = state.questions.find(q => q.id === currentQuestionIdForAI);

            if (!correctAnswer || !question) {
                alert("Please provide the correct answer.");
                return;
            }

            const prompt = `For the following multiple-choice question, the correct answer is provided.
            Generate exactly three plausible but incorrect options (distractors).
            Do not label them (e.g., a, b, c). Just provide the text for each distractor.
            Return the response as a JSON array of strings.
            
            Question: "${question.details}"
            Correct Answer: "${correctAnswer}"
            
            Example response format: ["Incorrect option 1", "Incorrect option 2", "Incorrect option 3"]`;

            const resultText = await callGemini(prompt, true);
            if (resultText) {
                try {
                    const distractors = JSON.parse(resultText);
                    const options = ['a', 'b', 'c', 'd'];
                    // Shuffle the correct answer with distractors
                    const allOptions = [correctAnswer, ...distractors].sort(() => Math.random() - 0.5);
                    
                    let final_text = `\n\n`;
                    allOptions.forEach((opt, i) => {
                        final_text += `${options[i]}) ${opt}\n`;
                    });

                    const textarea = document.getElementById(`details-${question.id}`);
                    textarea.value += final_text;
                    updateQuestionField(question.id, 'details', textarea.value);
                    closeModal('ai-distractors-modal');
                } catch(e) {
                    console.error("Failed to parse AI response for distractors:", e);
                    alert("The AI returned an invalid format for distractors. Please try again.");
                }
            }
        }

        // --- PREVIEW & PDF ---
        // All preview and PDF generation functions (selectTemplate, updateAllPreviews, generatePreviewHTML, downloadPDF) remain the same as before.
        function selectTemplate(templateId) {
            state.selectedTemplate = templateId;
            document.querySelectorAll('.template-content').forEach(el => el.classList.remove('border-4', 'border-blue-500'));
            document.getElementById(templateId).classList.add('border-4', 'border-blue-500');
        }

        function updateAllPreviews() {
            document.getElementById('template1').innerHTML = generatePreviewHTML('classic');
            document.getElementById('template2').innerHTML = generatePreviewHTML('modern');
            document.getElementById('template3').innerHTML = generatePreviewHTML('minimalist');
        }

        function generatePreviewHTML(style) {
            const { universityName, universityLogo, departmentName, courseName, courseCode, examType, totalMarks, totalTime, setNumber } = state.header;
            let headerHtml = '';
            switch (style) {
                case 'modern': headerHtml = `<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a202c; padding-bottom: 16px; margin-bottom: 24px;"><div><h1 style="font-size: 24px; font-weight: bold; color: #1a202c;">${universityName || 'University Name'}</h1><p style="font-size: 18px; color: #4a5568;">${departmentName || 'Department Name'}</p><p style="font-size: 16px; color: #718096;">${courseName || 'Course Name'} (${courseCode || 'Course Code'})</p></div>${universityLogo ? `<img src="${universityLogo}" alt="logo" style="height: 80px; width: 80px; object-fit: contain;">` : ''}</div><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;"><h2 style="font-size: 20px; font-weight: 600;">${examType || 'Exam Type'} ${setNumber ? `| Set: ${setNumber}` : ''}</h2><div><span style="font-weight: 600;">Marks:</span> ${totalMarks || 'N/A'} | <span style="font-weight: 600;">Time:</span> ${totalTime || 'N/A'}</div></div>`; break;
                case 'minimalist': headerHtml = `<div style="text-align: center; margin-bottom: 32px;">${universityLogo ? `<img src="${universityLogo}" alt="logo" style="height: 60px; margin: 0 auto 16px auto; object-fit: contain;">` : ''}<h1 style="font-size: 22px; font-weight: 600;">${universityName || 'University Name'}</h1><p style="font-size: 16px;">${departmentName || 'Department Name'}</p></div><hr style="margin-bottom: 16px;"><div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 16px;"><span>${courseName || 'Course Name'} (${courseCode || 'Course Code'})</span><span>${examType || 'Exam Type'}</span></div><div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 24px;"><span>Total Marks: ${totalMarks || 'N/A'}</span><span>Time: ${totalTime || 'N/A'}</span>${setNumber ? `<span>Set: ${setNumber}</span>` : ''}</div><hr style="margin-bottom: 24px;">`; break;
                default: headerHtml = `<div style="text-align: center; margin-bottom: 24px;">${universityLogo ? `<img src="${universityLogo}" alt="logo" style="height: 70px; margin: 0 auto 10px auto; object-fit: contain;">` : ''}<h1 style="font-size: 26px; font-weight: bold;">${universityName || 'University Name'}</h1><h2 style="font-size: 20px; font-weight: 500;">${departmentName || 'Department Name'}</h2><p style="font-size: 18px;">${courseName || 'Course Name'} (${courseCode || 'Course Code'})</p><p style="font-size: 18px; font-weight: 600; margin-top: 8px;">${examType || 'Exam Type'}</p></div><div style="display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 24px; padding-top: 10px; border-top: 1px solid #ccc;"><span>Total Marks: ${totalMarks || 'N/A'}</span>${setNumber ? `<span>Set: ${setNumber}</span>` : ''}<span>Time: ${totalTime || 'N/A'}</span></div>`;
            }
            const questionsHtml = state.questions.map(q => `<div style="margin-bottom: 20px;"><div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px;"><span>${q.number ? `Q${q.number}.` : ''}</span><span>[${q.marks || '0'}]</span></div><div style="padding-left: 20px;"><p style="white-space: pre-wrap; margin-bottom: 10px;">${q.details}</p>${q.image ? `<img src="${q.image}" style="max-width: 80%; height: auto; margin-top: 10px; border-radius: 5px;">` : ''}${generateTableHTML(q)}</div></div>`).join('');
            return `<div style="font-family: 'Times New Roman', serif;">${headerHtml}<div class="questions-body">${questionsHtml}</div></div>`;
        }
        
        function generateTableHTML(question) {
            if (!question.table || question.table.rows === 0) return '';
            let tableHtml = '<table style="width: 100%; margin-top: 10px; border-collapse: collapse; border: 1px solid black;">';
            for (let i = 0; i < question.table.rows; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < question.table.cols; j++) {
                    tableHtml += `<td style="border: 1px solid black; padding: 8px;">${question.table.data[i][j] || '&nbsp;'}</td>`;
                }
                tableHtml += '</tr>';
            }
            tableHtml += '</table>';
            return tableHtml;
        }

        function downloadPDF() {
            const element = document.getElementById(state.selectedTemplate);
            const opt = { margin: 0.5, filename: `${state.header.courseCode || 'Question'}_${state.header.examType || 'Paper'}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas:  { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            element.classList.remove('border-4', 'border-blue-500');
            html2pdf().from(element).set(opt).save().then(() => {
                element.classList.add('border-4', 'border-blue-500');
            });
        }
    </script>
</body>
</html>
